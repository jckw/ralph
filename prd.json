{
  "project": "Outro",
  "branchName": "feature/google-auth",
  "description": "Add Google Auth to Onboarding-V2 Flow - Enable users to sign up with Google OAuth in addition to email OTP",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix typecheck error in EmailVerify",
      "description": "As a developer, I need to fix the broken mutation call so the codebase compiles.",
      "acceptanceCriteria": [
        "Change api.auth.signUp to api.auth.completeSignup in EmailVerify.tsx",
        "Update input schema to match completeSignup handler expectations",
        "yarn workspace web typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create Dialog component with Tailwind",
      "description": "As a developer, I need a reusable Dialog component for the auth method modal.",
      "acceptanceCriteria": [
        "Create packages/app/components/ui/dialog.tsx using Radix UI Dialog primitives",
        "Style with Tailwind (centered modal, dark overlay, animations)",
        "Export Dialog, DialogTrigger, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Add persistence utilities for onboarding-v2",
      "description": "As a developer, I need to persist form data across OAuth redirects.",
      "acceptanceCriteria": [
        "Create packages/app/features/onboarding-v2/persistence.ts",
        "Export ONBOARDING_V2_FORM_DATA_KEY constant",
        "Export persistFormData(), getPersistedFormData(), clearPersistedFormData() functions",
        "Functions handle localStorage with try/catch for SSR safety",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create Auth Method Selection Modal",
      "description": "As a user, I want to choose between Google and email signup after entering my details.",
      "acceptanceCriteria": [
        "Create packages/app/features/onboarding-v2/tailwind/steps/AuthMethodModal.tsx",
        "Modal shows 'Continue with Google' button using GoogleAuthButton component",
        "Modal shows 'or' divider and 'Continue with email' button",
        "Google button stores form data in sessionStorage and initiates OAuth with callbackURL /start-v2?auth=google",
        "Email button calls onSelectEmail callback",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Created web-compatible GoogleIcon SVG since @outro/ui GoogleAuthButton uses react-native-svg. Used shadcn/ui Dialog and Button components with Tailwind."
    },
    {
      "id": "US-005",
      "title": "Update AccountCreate to trigger auth modal",
      "description": "As a user, after I fill in my account details, I want to choose my auth method.",
      "acceptanceCriteria": [
        "AccountCreate shows auth modal after form validation passes",
        "Form data passed to modal for persistence",
        "Email selection sends machine event to proceed to email_verification",
        "Google selection handled by modal (OAuth redirect)",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Added useState for modal visibility and validated form data. After form validation, stores data and shows modal. Email selection calls onNext with validated data to trigger NEXT event."
    },
    {
      "id": "US-006",
      "title": "Create CompleteSignup step for post-OAuth",
      "description": "As a user who signed up with Google, I want my account to be created with EHR/Stripe/HelpScout resources.",
      "acceptanceCriteria": [
        "Create packages/app/features/onboarding-v2/tailwind/steps/CompleteSignup.tsx",
        "Component auto-runs completeSignup mutation on mount",
        "Gets form data from localStorage (persisted before OAuth)",
        "Shows loading state while processing",
        "Shows needsReview message if account flagged",
        "Shows error state with retry button on failure",
        "Clears persisted data and calls onNext on success",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Created Tailwind/shadcn-based CompleteSignup component. Uses sessionStorage (not localStorage) to match AuthMethodModal pattern. Auto-runs completeSignup mutation on mount with hasStarted flag to prevent React strict mode double-execution."
    },
    {
      "id": "US-007",
      "title": "Update machine types for Google auth",
      "description": "As a developer, I need the machine context to support Google OAuth state.",
      "acceptanceCriteria": [
        "Add googleAuthCompleted: boolean to OnboardingV2MachineContext",
        "Add googleEmail: string | null to OnboardingV2MachineContext",
        "Add googleAuthCompleted, googleEmail, restoredFormData to OnboardingV2MachineInput",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Added googleAuthCompleted, googleEmail to context. Added restoredFormData to input and used it to initialize formData. Screen component uses default values for now."
    },
    {
      "id": "US-008",
      "title": "Update machine with complete_signup state",
      "description": "As a developer, I need the machine to route Google auth users to the complete signup step.",
      "acceptanceCriteria": [
        "Add complete_signup state to machine after checkAuth guards",
        "Add guard in checkAuth: if googleAuthCompleted && has required form data â†’ target complete_signup",
        "complete_signup transitions to insurance_details or payment based on is_using_insurance",
        "Initialize context with googleAuthCompleted, googleEmail, restoredFormData from input",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Added guard in checkAuth that checks googleAuthCompleted + required form data (first_name, last_name, phone, dob, location_state). Added complete_signup state with NEXT transitions based on is_using_insurance. Context initialization already done in US-007."
    },
    {
      "id": "US-009",
      "title": "Update step registry with new components",
      "description": "As a developer, I need the step registry to include the new components.",
      "acceptanceCriteria": [
        "Add complete_signup: CompleteSignup to stepComponents registry",
        "Import CompleteSignup from tailwind/steps",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Added CompleteSignup export to tailwind/steps/index.ts and added complete_signup entry to stepComponents registry in steps/index.ts."
    },
    {
      "id": "US-010",
      "title": "Update SSR page to detect OAuth callback",
      "description": "As a developer, I need the server to detect Google OAuth returns and pass state to client.",
      "acceptanceCriteria": [
        "Check ctx.query.auth === 'google' in getServerSideProps",
        "If callback and user authenticated, set googleAuthCompleted: true",
        "Pass googleEmail from authenticated user session",
        "Pass googleAuthCompleted and googleEmail as props",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Added OAuth detection in getServerSideProps. Updated Page component and OnboardingV2Screen to accept googleAuthCompleted and googleEmail props. Follows same pattern as v1 onboarding (start/index.tsx)."
    },
    {
      "id": "US-011",
      "title": "Update screen component to handle OAuth return",
      "description": "As a developer, I need the screen to restore form data and pass OAuth state to machine.",
      "acceptanceCriteria": [
        "Accept googleAuthCompleted, googleEmail props",
        "Restore form data from sessionStorage if googleAuthCompleted is true",
        "Clear sessionStorage after restoration",
        "Pass googleAuthCompleted, googleEmail, restoredFormData to machine input",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Added restoreAndClearFormData() function with SSR safety and try/catch. Used useMemo to ensure restoration runs once on mount. Passed actual prop values to machine input instead of hardcoded defaults."
    },
    {
      "id": "US-012",
      "title": "End-to-end email OTP flow verification",
      "description": "As a user, I want to sign up with email OTP and have my account created.",
      "acceptanceCriteria": [
        "Fill out AccountCreate form and click Create Account",
        "Select 'Continue with email' in auth modal",
        "Receive OTP and enter it in EmailVerify",
        "Account created successfully, proceeds to insurance_details or payment",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "End-to-end Google OAuth flow verification",
      "description": "As a user, I want to sign up with Google and have my account created.",
      "acceptanceCriteria": [
        "Fill out AccountCreate form and click Create Account",
        "Select 'Continue with Google' in auth modal",
        "Complete Google OAuth consent",
        "Return to /start-v2?auth=google, form data restored",
        "CompleteSignup runs automatically, account created",
        "Proceeds to insurance_details or payment",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    }
  ]
}
